#!/usr/bin/env bash
# Update a skill that was installed from GitHub
# Usage: github-update <skill-name> [--all]
#
# Examples:
#   github-update browser-tools
#   github-update --all

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_DIR="$(dirname "$(dirname "$SCRIPT_DIR")")"
GITHUB_SKILLS_DIR="$REPO_DIR/../github/skills"

usage() {
    echo "Usage: github-update <skill-name> | --all"
    echo ""
    echo "Update GitHub-installed skills to the latest version."
    echo ""
    echo "Arguments:"
    echo "  skill-name   Name of the skill to update"
    echo "  --all        Update all GitHub-installed skills"
    exit 1
}

update_skill() {
    local skill_name="$1"
    local skill_dir="$GITHUB_SKILLS_DIR/$skill_name"
    local source_file="$skill_dir/.github-source"

    if [[ ! -d "$skill_dir" ]]; then
        echo "Error: Skill '$skill_name' not found at $skill_dir"
        return 1
    fi

    if [[ ! -f "$source_file" ]]; then
        echo "Error: No .github-source file found for '$skill_name'"
        echo "This skill may not have been installed via github-install"
        return 1
    fi

    # Read source info
    local url=$(grep '^url:' "$source_file" | cut -d' ' -f2-)
    local owner=$(grep '^owner:' "$source_file" | cut -d' ' -f2-)
    local repo=$(grep '^repo:' "$source_file" | cut -d' ' -f2-)
    local branch=$(grep '^branch:' "$source_file" | cut -d' ' -f2-)
    local path=$(grep '^path:' "$source_file" | cut -d' ' -f2-)

    echo "Updating $skill_name from $owner/$repo..."

    # Create temp dir
    local tmpdir=$(mktemp -d)
    trap "rm -rf '$tmpdir'" RETURN

    # Sparse checkout
    cd "$tmpdir"
    git init -q
    git remote add origin "https://github.com/$owner/$repo.git"
    git config core.sparseCheckout true
    echo "$path" >> .git/info/sparse-checkout
    git fetch --depth 1 origin "$branch" -q
    git checkout -q FETCH_HEAD

    if [[ ! -f "$path/SKILL.md" ]]; then
        echo "Error: SKILL.md no longer exists at $path"
        return 1
    fi

    # Remove old skill (except .github-source) and copy new
    cd "$OLDPWD"
    
    # Preserve .github-source
    cp "$source_file" /tmp/.github-source.bak
    
    rm -rf "$skill_dir"
    cp -r "$tmpdir/$path" "$skill_dir"
    
    # Restore and update .github-source
    cat > "$skill_dir/.github-source" << EOF
url: $url
owner: $owner
repo: $repo
branch: $branch
path: $path
installed: $(grep '^installed:' /tmp/.github-source.bak | cut -d' ' -f2-)
updated: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
EOF

    rm -f /tmp/.github-source.bak

    echo "âœ“ Updated $skill_name"
}

if [[ $# -lt 1 ]]; then
    usage
fi

# Normalize path
GITHUB_SKILLS_DIR=$(cd "$REPO_DIR/.." && pwd)/github/skills

if [[ ! -d "$GITHUB_SKILLS_DIR" ]]; then
    echo "No GitHub skills installed at $GITHUB_SKILLS_DIR"
    exit 0
fi

if [[ "$1" == "--all" ]]; then
    echo "Updating all GitHub-installed skills..."
    echo ""
    
    for skill_dir in "$GITHUB_SKILLS_DIR"/*/; do
        if [[ -d "$skill_dir" ]]; then
            skill_name=$(basename "$skill_dir")
            update_skill "$skill_name" || true
            echo ""
        fi
    done
    
    echo "Done."
else
    update_skill "$1"
fi
